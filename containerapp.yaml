apiVersion: 2023-05-01
location: eastus
name: prosono-app
properties:
  environmentId: /subscriptions/{subscription-id}/resourceGroups/{resource-group}/providers/Microsoft.App/managedEnvironments/{environment-name}
  configuration:
    ingress:
      external: true
      targetPort: 8000
      transport: auto
      corsPolicy:
        allowedOrigins:
          - "*"
        allowedMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        allowedHeaders:
          - "*"
        allowCredentials: true
    secrets:
      - name: database-url
        value: "" # Set this to your Azure Database for PostgreSQL connection string
      - name: jwt-secret
        value: "" # Set this to a secure JWT secret key
    registries:
      - server: "{your-registry}.azurecr.io"
        username: ""
        passwordSecretRef: registry-password
  template:
    containers:
      - name: prosono-app
        image: "{your-registry}.azurecr.io/prosono-app:latest"
        env:
          - name: DATABASE_URL
            secretRef: database-url
          - name: JWT_SECRET_KEY
            secretRef: jwt-secret
          - name: JWT_ALGORITHM
            value: HS256
          - name: ENVIRONMENT
            value: production
          - name: REQUIRED_DAILY_SURVEYS
            value: "7"
        resources:
          cpu: 1.0
          memory: 2Gi
        probes:
          - type: liveness
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 10
          - type: readiness
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 5
            periodSeconds: 5
    scale:
      minReplicas: 1
      maxReplicas: 10
      rules:
        - name: http-scaler
          http:
            metadata:
              concurrentRequests: "50"
tags:
  environment: production
  application: prosono